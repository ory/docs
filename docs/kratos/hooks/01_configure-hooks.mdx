---
id: configure-hooks
title: Add and configure hooks for self-service user flows
sidebar_label: Configuration
toc_max_heading_level: 4
---

Ory Identities (Kratos) allows you to enrich self-service user flows by executing additional logic at specific points of the
selected flow. This includes calling external services, for example, Mailchimp, Segment, HubSpot, or Zapier. You enrich the flows
through hooks.

Adding hooks to self-service flows can help you shape your customers' user experience, increase the security of your solution by
adding additional verifications, and exchange information with external systems.

## When can you use hooks?

You can use hooks at specific points of select self-service flows:

- `before` login: The hook runs when the user starts the login flow.
- `after` login: The hook runs when the user is successfully authenticated, before the system issues an Ory Session.
- `before` registration: The hook runs when a registration flow starts.
- `after` registration: The hook runs when a user successfully registers in the system.
- `before` recovery: The hook runs when the user starts the recovery flow.
- `after` recovery: The hook runs when the user successfully recovers their password.
- `before` settings: The hook runs when the user starts the account settings flow.
- `after` settings: The hook runs when the user successfully changes their account settings.
- `before` verification: The hook runs when the user starts the verification flow.
- `after` verification: The hook runs when the user verifies their account.

### Hooks for specific authentication methods

The login and registration self-service flows support multiple authentication methods:

| Authentication method | Description                                                                                    |
| :-------------------- | :--------------------------------------------------------------------------------------------- |
| `password`            | Sign-in and sign-up with username and password.                                                |
| `oidc`                | Sign-in and sign-up through OIDC-compliant OAuth2 identity providers.                          |
| `totp`                | Sign-in with a TOTP code from apps such as Google Authenticator.                               |
| `webauthn`            | Sign-in with WebAuthn-compatible factors (FaceID, YubiKey) or paswordless sign-up and sign-in. |
| `lookup_secret`       | Sign-in with recovery codes.                                                                   |

:::tip

You can use the authentication methods to further specify when you want to run hooks. For example, you can run a hook for the
login flow with the `password` method and not run any hooks for logins with the `oidc` method.

:::

## Available hooks

There are three predefined hooks you can use to extend self-service user flows, plus the customizable `web_hook` option. Note that
some hooks can only be used for specific flows and methods.

| Hook                       | Description                                                          | Constraints                                                                                                                                                                                         |
| :------------------------- | :------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `session`                  | Signs in the user immediately after they create an account.          | For use only with the `after` registration flow. To use it, you must define secrets for secret rotation.                                                                                            |
| `revoke_active_sessions`   | Revokes all other active sessions of the user on successful login.   | For use only with the login flow.                                                                                                                                                                   |
| `require_verified_address` | Allows users to sign in only when they verified their email address. | For use only with the `after` login flow, `password` method only.                                                                                                                                   |
| `web_hook`                 | Instructs Ory Identities to call a customizable HTTPS endpoint.      | Can be used with all flows and methods except error and logout. The only hook type available for the `after` settings flow. See an example of using webhooks [here](../../guides/actions/webhooks). |

## Configuration

````mdx-code-block
import CodeBlock from '@theme/CodeBlock'
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs groupId="wherehosted">
  <TabItem value="cloud" label="The Ory Network" default>

To add hooks to flows:

1. Get the Ory Identities config with Ory CLI:

   ```shell
   ## List all available projects
   ory list projects

   ## Get config
   ory get identity-config <project-id> --format yaml > identity-config.yaml
   ```

2. Add the hook configuration to the downloaded file.
3. Update the Ory Identities configuration using the file you worked with:

   ```shell
   ory update identity-config <project-id> --file updated_config.yaml
   ```


  </TabItem>
  <TabItem value="selfhosted" label="Self-Hosted Ory Kratos Config" default>

To add hooks to flows, edit the Ory Kratos configuration file.

  </TabItem>
</Tabs>
````

### Add hooks for all methods of a flow

To configure hooks for all methods of a particular flow, use this pattern:

```yaml
selfservice:
  flows:
    login: # Defines for which flow triggers the hook. No method defined = applies to all methods.
      before: # Defines the point at which the hook runs.
        hooks:
          - hook: <hook 1 name> # Specifies which hook is triggered.
```

### Add hooks for particular method of a flow

To configure hooks for a particular flow method, use this pattern:

```yaml
selfservice:
  flows:
    registration: # Defines for which flow triggers the hook.
      after: # Defines the point at which the hook runs.
        password: # When method is defined, the hook is triggered only for this particular method and flow.
          hooks:
            - hook: <hook 1 name> # Specifies which hook is triggered.
```

#### Hook precedence

Hooks configured on the method level always override the hooks configured on the flow level. When you apply the following hook
configuration, `hook_1` always runs when the login flow is started. On the finalization of the flow, `hook_2` runs only for
methods other than `password`. If the `password` method is used, the system triggers `hook_3`.

```yaml
selfservice:
  flows:
    login:
      before:
        hooks:
          - hook: hook_1
      after:
        hooks:
          - hook: hook_2
        password:
          hooks:
            - hook: hook_3
```

## `session` hook configuration

To use the `session` hook you must define secrets for secret rotation:

```yaml
secrets:
  cookie:
    - something-super-secret # The first entry will be used to sign and verify session cookies

    # All other entries will be used to verify session cookies that were signed before
    # "something-super-secret" became the current signing secret.
    - old-session-secret
    - older-session-secret
    - ancient-session-secret

selfservice:
  flows:
    registration:
      after:
        oidc:
          hooks:
            - hook: session
```

#### Behavior depending on registration flow

The hook behaves differently depending on the registration flow used:

- Registration through a web browser

  The hook sends a `Set-Cookie` HTTP header which contains the session cookie. The user is signed in immediately.

  :::warning

  Using this job as part of your post-registration workflow makes your system vulnerable to Account Enumeration Attacks because a
  threat agent can distinguish between existing and non-existing accounts by checking if Set-Cookie was sent as part of the
  registration response.

  :::

- Registration through the API (mobile app)

  When the registration is performed through an API client (such as a mobile app), the hook creates a session and returns the
  session token and the session itself in the response body as `application/json`:

  ```json
  {
    "session": {
      "id": "..."
      // ...
    },
    "session_token": "...",
    "identity": {
      "id": "..."
      // ...
    }
  }
  ```

:::info

The HTTP response is set by the hook. As a result, no other hooks can be executed after the `session` hook. This is because the
initial HTTP response can't be modified by subsequent hooks.

If you want to trigger multiple hooks in your setup, make sure that `session` is the last executed hook.

:::

---
id: claims-at-refresh
title: Customize JWT claims with webhooks
sidebar_label: webhooks
keywords:
  - webhooks
  - custom
  - customize
  - claims
  - jwt
  - access
  - token
---

# Customizing JWT claims with webhooks

```mdx-code-block
import CodeBlock from '@theme/CodeBlock';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem'
```

You can modify aspects of the JWT tokens returned from the `/whoami` endpoint. A typical use case is
adding custom claims to the tokens.

Customize the token response by registering a webhook endpoint in the configuration. Before the token is issued to the
client, Ory will call your HTTPS endpoint with information about the client requesting the token.

Your endpoint's response to the webhook will be used to customize the token that Ory issues to the client.

Using webhooks is supported for all flows.

If your endpoint is gated behind authentication, ensure that the configuration contains the correct credentials. They will be sent in the request when contacting the endpoint.

:::note

The webhook is called before any other logic is executed. If the webhook execution fails -- for example if your endpoint is
unreachable or responds with an HTTP error code -- the token exchange will fail for the client.

:::

## Configuration

Use the Ory CLI to register your webhook endpoint:

```mdx-code-block
<Tabs>
  <TabItem value="header-auth" label="with authentication in header" default >
    <CodeBlock language="shell">{
`ory patch identity-config --project <project-id> --workspace <workspace-id> \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/url="https://my-example.app/token-hook"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/type="api_key"' \\
  --add 'session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/config/in="header"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/config/name="X-API-Key"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/config/value="MY API KEY"' \\
  --format yaml`}
    </CodeBlock>
  </TabItem>
  <TabItem value="cookie-auth" label="with authentication in cookie">
    <CodeBlock language="shell">{
`ory patch identity-config --project <project-id> --workspace <workspace-id> \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/url="https://my-example.app/token-hook"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/type="api_key"' \\
  --add 'session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/config/in="cookie"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/config/name="X-Cookie-Name"' \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/auth/config/value="MY SECRET COOKIE"' \\
  --format yaml`}
    </CodeBlock>
  </TabItem>
  <TabItem value="no-auth" label="no authentication">
    <CodeBlock language="shell">{
`ory patch identity-config --project <project-id> --workspace <workspace-id> \\
  --add '/session/whoami/tokenizer/templates/jwt_template_1/claims_hook/url="https://my-example.app/token-hook"' \\
  --format yaml`}
    </CodeBlock>
  </TabItem>
</Tabs>
```

## Webhook payload

Ory will perform a POST request with a JSON payload towards your endpoint.

```json title="Example OAuth2 token webhook request payload"
{
  "request_headers": {
    "X-Claim-Name": [
      "a custom claim"
    ]
  },
  "request_method": "GET",
  "request_url": "http://example.com/sessions/whoami",
  "request_cookies": {},
  "session": {
    "id": "432caf86-c1d8-401c-978a-8da89133f78b",
    "active": true,
    "expires_at": "2025-08-22T16:29:26.579741+02:00",
    "authenticated_at": "2025-08-21T16:29:26.579741+02:00",
    "authenticator_assurance_level": "aal1",
    "authentication_methods": [
      {
        "method": "password",
        "aal": "aal1",
        "completed_at": "2025-08-21T14:29:26.899803Z"
      }
    ],
    "issued_at": "2025-08-21T16:29:26.579741+02:00",
    "identity": {
      "id": "7458af86-c1d8-401c-978a-8da89133f78b",
      "external_id": "external-id",
      "schema_id": "default",
      "schema_url": "http://localhost/schemas/ZGVmYXVsdA",
      "state": "active",
      "state_changed_at": "2025-08-21T14:29:26.899788Z",
      "traits": {},
      "metadata_public": null,
      "created_at": "0001-01-01T00:00:00Z",
      "updated_at": "2025-08-21T16:29:26.900034+02:00",
      "organization_id": null
    },
    "devices": [
      {
        "id": "00000000-0000-0000-0000-000000000000",
        "ip_address": "192.0.2.1:1234",
        "user_agent": null,
        "location": ""
      }
    ],
    "tokenized": "eyJhbGciOiJFUzUxMiIsImtpZCI6ImJjN2Y3YWZjLTY3NDItNDI3Yy1iYjllLTE2NGZlMGY4YjZhNyIsInR5cCI6IkpXVCJ9.eyJhYWwiOiJhYWwxIiwiZXhwIjoxNjc1MjA5NjYwLCJleHRlcm5hbF9pZCI6ImV4dGVybmFsLWlkIiwiZm9vIjoiYmFyIiwiaWF0IjoxNjc1MjA5NjAwLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0LyIsImp0aSI6IjYwZjdjOGU2LTIxYzMtNGExYi1hMTBhLTRjZjUyNmVhOWMzOCIsIm5iZiI6MTY3NTIwOTYwMCwic2NoZW1hX2lkIjoiZGVmYXVsdCIsInNlY29uZF9jbGFpbSI6MTY3NTIwOTY2MCwic2lkIjoiNDMyY2FmODYtYzFkOC00MDFjLTk3OGEtOGRhODkxMzNmNzhiIiwic3ViIjoiZXh0ZXJuYWwtaWQifQ.AXSrbfjtCvufuZEosTeHbS_oo01MiwdaB3ebS96pb9fO51QkC0rQHadY2hC3Ig4SP2x60NMl-Ff5mlEp4QTY9tPIATwFPbXFs-dBCKlZsLk7RA_s2fi4JXTQJU2WbxdHNGn_W3tL4IsTIQLPrrxXd301c72kDc4TVhLX99kIlasheBas"
  },
  "claims": {
    "exp": 1675209660,
    "iat": 1675209600,
    "iss": "http://localhost/",
    "jti": "eecab9dd-86fe-469a-8c04-ed7e103aea1e",
    "nbf": 1675209600,
    "sid": "432caf86-c1d8-401c-978a-8da89133f78b",
    "sub": "7458af86-c1d8-401c-978a-8da89133f78b"
  }
}
```

`request` contains information from the client's request to the `/whoami` endpoint.

## Responding to the webhook

When handling the webhook in your endpoint, use the request payload to decide how Ory should proceed in the token exchange with
the client.

To accept the token exchange without modification, return a `204` or `200` HTTP status code without a response body.

To deny the token exchange, reply with a `403` HTTP status code.

To keep the claims as is, return an empty body with a 204 status code.

To modify the claims of the issued tokens and instruct Identities to proceed with the token exchange, return `200` with a JSON response
body containing the claims that the final JWT should contain:

```json
{
  "claims": {
    "name": "John Doe",
    "admin": true
  }
}
```

For the happy path, the response body must be an object containing a key `claims`, whose value is a map of string keys to any value. Each key-value in the `claims` object will be added to the final JWT claims.

Responding with any other HTTP status code will abort the token exchange toward the client with an error message. In case of a 40x or 50x response code from your endpoint, a response body of any shape can be sent and it will be included in the error sent back to the client on a best effort basis.

## Updated tokens

Tokens issued by Ory to the client will contain the data from your webhook response:

```json
{
  "admin": true,
  "exp": 1675209660,
  "iat": 1675209600,
  "iss": "http://localhost/",
  "jti": "d4ef10de-bffd-48cb-a9cf-3cab91d4f5c2",
  "name": "John Doe",
  "nbf": 1675209600,
  "sid": "432caf86-c1d8-401c-978a-8da89133f78b",
  "sub": "7458af86-c1d8-401c-978a-8da89133f78b"
}
```

:::note

You cannot override the token subject.

:::

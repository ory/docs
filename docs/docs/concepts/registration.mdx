---
id: registration
title: User Registration Flow
---

import Mermaid from '@theme/Mermaid'
import ApiWarning from '@theme/ApiWarning'
import CodeFromRemote from '@theme/CodeFromRemote'
import SelfServiceBrowserFlow from '@theme/SelfServiceBrowserFlow'
import SelfServiceApiFlow from '@theme/SelfServiceApiFlow'

import CodeTabs from '@theme/Code/CodeTabs'
import {
  initBrowserFlow,
  initApiFlow,
  getFlow,
  getFlowMethodPasswordWithErrors,
  getFlowMethodOidcWithErrors,
  getFlowMethodOidcWithCompletion
} from './code/registration'
import RenderFlow from '@theme/Code/RenderFlow'


## User Registration

:::info

Please read the [Get Started guide](../get-started.mdx) first.

:::

There are two Registration Flow types supported in Ory:

- The user is connecting through the Browser (e.g. website, SPA, etc.)
- The user is connecting through a device (e.g. mobile app, Smart TV, etc.) requiring API interaction

The Registration Flow can be summarized as the following state machine:

<Mermaid
  chart={`
stateDiagram
  s1: Flow is initialized
  s2: Execute Before Registration Hook(s)
  s3: User Interface renders Registration Flow Forms
  s4: Execute After Registration Hook(s)
  s5: Update Registration Flow with Error Context(s)
  s6: Registration successful
	[*] --> s1 : User clicks "Sign up"
  s1 --> s2
  s2 --> Error : A hook fails
  s2 --> s3
  s3 --> s4 : User provides valid registration data
  s3 --> s5 : User provides invalid registration data
  s5 --> s3
  s4 --> Error : A hook fails
  s4 --> s6
  s6 --> [*]
  Error --> [*]
`}
/>

Ory offers two main methods of registrations:

- `password` prompts the end-user to register with an email / username and password combination;

- `oidc` lets the end-user register using an existing account at a social sign in provider such as Google or Facebook.

Currently only the `password` registration methods is supported. The `oidc` method will be added soon. 
Which method should be used will be configurable in the Ory Project Settings individually for each project.

<!-- Check if we leave this in? -->

## Begin Registration Flow

When the self service Registration Flow begins, Ory sets anti-CSRF tokens and runs pre-registration hooks.

### Registration for Browser Clients

The Registration Flow for Browser Clients uses HTTP redirects between the end-user's browser, Ory and the registration UI:

<SelfServiceBrowserFlow
  flows={['registration']}
  success="User created and successful HTTP 302 redirect"
  interactions={['"Sign up"']}
/>

To begin the registration flow, open the initialization
endpoint in the Browser :

<!-- The response needs to be updated? -->

<CodeTabs items={initBrowserFlow} />

The server answers with a HTTP 303 and redirects the end-user to the registration UI, appending
the query parameter `?flow=<flow-id>`  (see the curl example) to the URL
configured here:

```yaml 
registration:
    # becomes http://127.0.0.1:4455/auth/registration?flow=df607aa1-d555-4b2a-b3e4-0f5a1d2fe6f3
    ui_url: http://127.0.0.1:4455/auth/registration
```
### Registration for API Clients

<ApiWarning />

The end-user is connecting through another device to your service through a "smart" device like a mobile phone, TV, watch ect.
These devices either dont have a browser or are using native applications to connect to services.  
Because of this smart devices require a different flow from the one for Browser Clients described above. 

Clients (e.g. the native app or smart device) that use this flow are called API Clients.

The Registration Flow for API Clients does not use HTTP Redirects.

The flow can can be summarized like so:

<SelfServiceApiFlow
  flows={['registration']}
  success="User created and HTTP 200 OK response"
  interactions={['"Sign in"']}
/>

To begin the API flow, the client calls the API-flow initialization
endpoint and returns a JSON response:

<!-- REST API Reference to be added? -->

<CodeTabs items={initApiFlow} />

## Registration Form Payloads

To get more info on a specific flow you can display the details of any flow using the Registration Flow ID. 

This is in most cases only required for Browser Clients but it works just the same for API Clients. 

To display a specific flow you just need the valid Registration Flow ID:

<!-- REST API Reference to be added? -->


<CodeTabs items={getFlow} />

### Registration with Username/Email and password

:::tip Before you start

Please read the
[Identity Data Model Documentation](./concepts/identity.mdx)
first.

:::

When using the  `password` method, it will be part of the `methods` payload in the Registration Flow.
Ory uses the Identity Model defined in the Ory Project Settings to generate a list of form fields and add it to
the Registration Flow.

<CodeFromRemote
  language="json"
  link="https://github.com/ory/kratos/blob/master/contrib/quickstart/kratos/email-password/identity.schema.json"
  src="https://raw.githubusercontent.com/ory/kratos/master/contrib/quickstart/kratos/email-password/identity.schema.json"
/>

the response would look like so:

```shell script
$ curl -H "Accept: application/json" -s \
  'https://distracted-elion-yl0zho4q9i.projects.oryapis.com/api/kratos/public/self-service/registration/flows?id=a43dfd74-e80c-4e39-896e-1743f1fa3c67' | jq
  
{
  "id": "a43dfd74-e80c-4e39-896e-1743f1fa3c67",
  "type": "browser",
  "expires_at": "2021-06-01T22:13:17.977131Z",
  "issued_at": "2021-06-01T21:13:17.977131Z",
  "request_url": "http://distracted-elion-yl0zho4q9i.projects.oryapis.com/self-service/registration/browser",
  "ui": {
    "action": "https://distracted-elion-yl0zho4q9i.projects.oryapis.com/api/kratos/public/self-service/registration?flow=a43dfd74-e80c-4e39-896e-1743f1fa3c67",
    "method": "POST",
    "nodes": [
      {
        "type": "input",
        "group": "default",
        "attributes": {
          "name": "csrf_token",
          "type": "hidden",
          "value": "dJHidyZw26lMZLYMfOcmzeJuMUTEIfuhBL3G11jjDy37LIpSO7ue3x1a2G/dCq0OYcZ63Byz+2/buDLGTzA3Yg==",
          "required": true,
          "disabled": false
        },
        "messages": null,
        "meta": {}
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "traits.email",
          "type": "email",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070002,
            "text": "E-Mail",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "password",
          "type": "password",
          "required": true,
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070001,
            "text": "Password",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "traits.name.first",
          "type": "text",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070002,
            "text": "First name",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "traits.name.last",
          "type": "text",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070002,
            "text": "Last name",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "traits.newsletter",
          "type": "checkbox",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070002,
            "text": "Newsletter subscription",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "method",
          "type": "submit",
          "value": "password",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1040001,
            "text": "Sign up",
            "type": "info",
            "context": {}
          }
        }
      }
    ]
  }
}
```


## Registration Flow Form Rendering

The registration user interface is the page in your application (server, native app, single page app) that renders and displays the registration form to the end-user.

Ory gives you the option to use a template for all self-service end-user interfaces.

You can find the template UIs in your Ory project under `Ory Managed UI` or  `$yourProjectSlug/hosted` .

You also have the option to implement your own user interface, for individual styling and branding.

This interface needs to be implemented in your application (e.g.
NodeJS + ExpressJS, Java, PHP, ReactJS, ...), and also rendered there. 
This enables you to customize your end-user experience and keep existing flows and designs. 

The JSON response from the Registration Flow will be used to render the registration user interface.
How this looks exactly depends on your business logic, framework and of course the programming language.

<RenderFlow flow="registration" />

<!-- Remove imcomplete examples? -->


## Registration Form Validation

The form payloads are then submitted to Ory which responds with:

- For Browser Clients: An `HTTP 302 Found` redirect to the registration UI for browser
  clients.
- For API Clients: An `application/json` response for API Clients.

### Registration with Username/Email and Password

To finish the registration process, the end-user fills out the form.

The form must include a field marked as the identifier in the Identity JSON
Schema, for example:

```diff
 {
   "$id": "https://schemas.ory.sh/presets/kratos/quickstart/email-password/identity.schema.json",
   "$schema": "http://json-schema.org/draft-07/schema#",
   "title": "Person",
   "type": "object",
   "properties": {
     "traits": {
       "type": "object",
       "properties": {
         "email": {
           "type": "string",
           "format": "email",
+          "ory.sh/kratos": {
+            "credentials": {
+              "password": {
+                "identifier": true
+              }
+            }
+          }
         }
       },
       "required": [
         "email"
       ],
       "additionalProperties": false
     }
   }
 }
```



If the registration payload is invalid (e.g. the password does not match the
password policy, the email is missing, ...), the password method includes the
validation errors:

<CodeTabs items={getFlowMethodPasswordWithErrors} />

When validation errors happen, Browser Clients receive a HTTP 302 Found redirect
to the Registration Flow UI, containing the Registration Flow ID which includes
the error payloads.

For API Clients, the server typically responds with HTTP 400 Bad Request and the
Registration Flow in the response payload as JSON.

## Successful Registration

A successful registration looks different for Browser Clients and API Clients. 
You can choose wether the user will be signed in after registration, or if they have to go through the Login Flow after registration.
You can toggle this option in the Authentication section of your Ory Project Settings.

The Registration Flow does not issue a Ory Login Session automatically to
prevent Account Enumeration Attacks.
  
### Browser Clients

When the registration is completed successfully, Ory responds with a HTTP
302 Redirect to the configured redirect URL.

You can configure this in the Ory Projects Settings.

<!-- Where? -->

#### With Auto-Login on Registration

If automatic sign in after registration is enabled in the Ory Project Settings, a `Set-Cookie` HTTP Header is set
alongside the HTTP 302 redirect which contains the Ory Login Session
Cookie:

```
HTTP/1.1 302 Found
Cache-Control: 0
Location: http://127.0.0.1:4455/
Set-Cookie: csrf_token=b8OebRPTPr5ow23mA5gIZmFNLeuMbv8pZz1jT1Ex7ys=; Path=/; Domain=127.0.0.1; Max-Age=31536000; HttpOnly
Set-Cookie: ory_kratos_session=MTU5OTE2ODc2N3xEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJR055VlROMGRteHhSakJrUzBkbmRUUjBlVFY1V0RCRWFVTnJXVmR6V25oaHx2DICsB6IMbaHSQwnYITUZqr7Qx7CxUlnaneJWH495wQ==; Path=/; Expires=Fri, 04 Sep 2020 21:32:47 GMT; Max-Age=86400; HttpOnly; SameSite=Lax
Vary: Cookie
Date: Thu, 03 Sep 2020 21:32:47 GMT
Content-Length: 0
```

Now, whenever the browser is making a request (with cookies) to the
`http://127.0.0.1/sessions/whoami` endpoint, the session will be returned:

```shell script
curl -s -H "Cookie: ory_kratos_session=MTU5OTE2ODc2N3xEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJR055VlROMGRteHhSakJrUzBkbmRUUjBlVFY1V0RCRWFVTnJXVmR6V25oaHx2DICsB6IMbaHSQwnYITUZqr7Qx7CxUlnaneJWH495wQ==" \
  http://127.0.0.1:4433/sessions/whoami | jq

{
  "id": "ede90ce6-2420-435a-a745-3d8ab1a9636c",
  "active": true,
  "expires_at": "2020-09-04T21:32:47.5642404Z",
  "authenticated_at": "2020-09-03T21:32:47.5881038Z",
  "issued_at": "2020-09-03T21:32:47.5642688Z",
  "identity": {
    "id": "d96e86d9-bc33-4aa5-b865-4ade8a3974b3",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "foouser@ory.sh",
      "name": {
        "first": "foo",
        "last": "user"
      }
    },
    "verifiable_addresses": [
      {
        "id": "81bbdeae-6333-42f2-877e-26c78acb6ea5",
        "value": "foouser@ory.sh",
        "verified": false,
        "via": "email",
        "status": "pending",
        "verified_at": null
      }
    ],
    "recovery_addresses": [
      {
        "id": "596c1db4-ccaa-4f4e-9623-cb7e768026ad",
        "value": "foouser@ory.sh",
        "via": "email"
      }
    ]
  }
}
```

### API Clients

For API Clients, the reponse is a JSON payload including the identity that is signed in:

```shell script
# Inits a Registration Flow
$ actionUrl=$(\
  curl -s -X GET -H "Accept: application/json" \
    "http://127.0.0.1:4433/self-service/registration/api" \
    | jq -r '.ui.action'\
)

# Complete Registration Flow with password method
$ curl -s -X POST -H  "Accept: application/json" -H "Content-Type: application/json" \
    -d '{"traits.email": "registration-api@user.org", "password": "fhAzi860a", "method": "password"}' \
    "$actionUrl" | jq

{
  "identity": {
    "id": "d8baf63b-7ce6-4275-82b9-9ac6d97e5037",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "registration-api@user.org"
    },
    "verifiable_addresses": [
      {
        "id": "87defb49-ad69-461c-b5f6-56c1ec39dd39",
        "value": "registration-api@user.org",
        "verified": false,
        "via": "email",
        "status": "pending",
        "verified_at": null
      }
    ],
    "recovery_addresses": [
      {
        "id": "232793b8-8d60-427d-89e6-d0a97a7a172c",
        "value": "registration-api@user.org",
        "via": "email"
      }
    ]
  }
}
```

#### With Auto-Login on Registration


If automatic sign in after registration is enabled in the Ory Project Settings, the Ory Login Session and Ory Login Session Token are included in the response:

```shell script
$ actionUrl=$(\
  curl -s -X GET -H "Accept: application/json" \
    "http://127.0.0.1:4433/self-service/registration/api" \
    | jq -r '.ui.action'\
)

$ curl -s -X POST -H  "Accept: application/json" -H "Content-Type: application/json" \
    -d '{"traits.email": "registration-api@user.org", "password": "fhAzi860a", "method": "password"}' \
    "$actionUrl" | jq

{
  "session_token": "9kmrgslvw8ZCyEtSZqOmxEtnfBJIvB31",
  "session": {
    "id": "6d5ef6f4-ea54-4310-a762-473499835a48",
    "active": true,
    "expires_at": "2020-09-08T10:12:34.792802227Z",
    "authenticated_at": "2020-09-07T10:12:34.797538934Z",
    "issued_at": "2020-09-07T10:12:34.792813032Z",
    "identity": {
      "id": "8a7755df-1aac-4477-a53c-3f16fa059113",
      "schema_id": "default",
      "schema_url": "http://127.0.0.1:4433/schemas/default",
      "traits": {
        "email": "registration-session-api@user.org"
      },
      "verifiable_addresses": [
        {
          "id": "95139fe8-3360-4b08-adf6-4cc9b4555d86",
          "value": "registration-session-api@user.org",
          "verified": false,
          "via": "email",
          "status": "pending",
          "verified_at": null
        }
      ],
      "recovery_addresses": [
        {
          "id": "e6987729-b6fa-48d5-aa15-c0a57edfdfc4",
          "value": "registration-session-api@user.org",
          "via": "email"
        }
      ]
    }
  },
  "identity": {
    "id": "8a7755df-1aac-4477-a53c-3f16fa059113",
    "schema_id": "default",
    "schema_url": "http://127.0.0.1:4433/schemas/default",
    "traits": {
      "email": "registration-session-api@user.org"
    },
    "verifiable_addresses": [
      {
        "id": "95139fe8-3360-4b08-adf6-4cc9b4555d86",
        "value": "registration-session-api@user.org",
        "verified": false,
        "via": "email",
        "status": "pending",
        "verified_at": null
      }
    ],
    "recovery_addresses": [
      {
        "id": "e6987729-b6fa-48d5-aa15-c0a57edfdfc4",
        "value": "registration-session-api@user.org",
        "via": "email"
      }
    ]
  }
}
```


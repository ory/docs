---
id: user-login
title: User Login Flow
---

import Mermaid from '@theme/Mermaid'
import ApiWarning from '@theme/ApiWarning'
import SelfServiceBrowserFlow from '@theme/SelfServiceBrowserFlow'
import SelfServiceApiFlow from '@theme/SelfServiceApiFlow'

import CodeTabs from '@theme/Code/CodeTabs'
import {
  initBrowserFlow,
  initApiFlow,
  getFlow,
  getFlowMethodPasswordWithErrors,
  getFlowMethodOidcWithErrors
} from './code/login'
import RenderFlow from '@theme/Code/RenderFlow'

:::info

Please read the [Get Started guide](../get-started.mdx) first.

:::


There are two Login Flow types supported in Ory:

- The user is connecting through the Browser (e.g. website, SPA, etc.)
- The user is connecting through a device (e.g. mobile app, Smart TV, etc.) requiring API interaction

The Login Flow can be summarized as the following state machine:

<Mermaid
  chart={`
stateDiagram
  s1: Flow is initialized
  s2: Execute Before Login Hook(s)
  s3: User Interface renders Login Flow Forms
  s4: Execute After Login Hook(s)
  s5: Update Login Flow with Error Context(s)
  s6: Login successful
	[*] --> s1 : User clicks "Log in"
  s1 --> s2
  s2 --> Error : A hook fails
  s2 --> s3
  s3 --> s4 : User provides valid credentials data
  s3 --> s5 : User provides invalid credentials data
  s5 --> s3
  s4 --> Error : A hook fails
  s4 --> s6
  s6 --> [*]
  Error --> [*]
`}
/>

Ory offers two main methods of login:

- `password` prompts the end-user to log in with an email / username and password combination;

- `oidc` lets the end-user log in using an existing account at a social sign in provider such as Google or Facebook.

Currently only the `password` login method is supported. The `oidc` method will be added soon.  
Which method should be used will be configurable in the Ory Project Settings individually for each project.

## Initialize Login Flow

When the Self Service Login Flow begins, Ory sets anti-CSRF tokens and runs pre-login hooks.

### Login for Browser Clients

The Login Flow for Browser Clients uses HTTP redirects between the end-user's browser, Ory and the registration UI:


<SelfServiceBrowserFlow
  flows={['login']}
  success="Set session cookie"
  interactions={['"Log in"']}
/>

To begin the Login Flow, open the initialization
endpoint in the Browser :

<CodeTabs items={initBrowserFlow} />

The server answers with a HTTP 303 and redirects the end-user to the Login UI, appending
the query parameter `?flow=<flow-id>` to the URL

```yaml
ui_url: http://$ORY_PROJECT_PUBLIC_API/self-service/login/browser
--> http://$ORY_PROJECT_PUBLIC_API/self-service/login/browser?flow=df607aa1-d555-4b2a-b3e4-0f5a1d2fe6f3

```

### Login for API Clients

<ApiWarning />

The Login Flow for API Clients does not use HTTP Redirects.

The flow can can be summarized like so:

<SelfServiceApiFlow
  flows={['login']}
  success="Return login session token"
  interactions={['"Log in"']}
/>

To begin the API Login Flow, the client calls the API-flow initialization
endpoint and returns a JSON response:

<CodeTabs items={initApiFlow} />

## Login Flow Payloads

To get more info on a specific flow you can display the details of any flow using the Login Flow ID.

This is in most cases only required for Browser Clients but it works just the same for API Clients.

To display a specific flow you just need the valid Login Flow ID:

<CodeTabs items={getFlow} />

### Login with Username/Email and Password

<!-- add from [Username / Email & Password Credentials Documentation](../../concepts/credentials/username-email-password#choosing-between-username-email-phone-number) -->

When using the `password` method, it will be part of the `methods` payload in the Login Flow.
Ory uses the Identity Model defined in the Ory Project Settings to generate a list of form fields and add it to
the Login Flow.

```shell script
curl -H "Accept: application/json" -s \
    'https://$ORY_PROJECT_SLUG/api/kratos/public/self-service/login/flows?id=91fc476d-5a99-4b86-aa68-3d588188c80a' | jq
{
  "id": "91fc476d-5a99-4b86-aa68-3d588188c80a",
  "type": "api",
  "expires_at": "2021-06-07T20:32:10.567173Z",
  "issued_at": "2021-06-07T19:32:10.567173Z",
  "request_url": "http://silly-chebyshev-xzqt5tdzrg.projects.oryapis.com/self-service/login/api",
  "ui": {
    "action": "https://$ORY_PROJECT_SLUG/api/kratos/public/self-service/login?flow=91fc476d-5a99-4b86-aa68-3d588188c80a",
    "method": "POST",
    "nodes": [
      {
        "type": "input",
        "group": "default",
        "attributes": {
          "name": "csrf_token",
          "type": "hidden",
          "value": "",
          "required": true,
          "disabled": false
        },
        "messages": null,
        "meta": {}
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "password_identifier",
          "type": "text",
          "value": "",
          "required": true,
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070004,
            "text": "ID",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "password",
          "type": "password",
          "required": true,
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1070001,
            "text": "Password",
            "type": "info"
          }
        }
      },
      {
        "type": "input",
        "group": "password",
        "attributes": {
          "name": "method",
          "type": "submit",
          "value": "password",
          "disabled": false
        },
        "messages": null,
        "meta": {
          "label": {
            "id": 1010001,
            "text": "Sign in",
            "type": "info",
            "context": {}
          }
        }
      }
    ]
  },
  "created_at": "2021-06-07T19:32:10.56881Z",
  "updated_at": "2021-06-07T19:32:10.56881Z",
  "forced": false
}

```

## Login Flow Form Rendering

The Login User Interface is the page in your application (server, native app, single page app) that renders and displays the Login Form to the end-user.

Ory gives you the option to use a template for all self service end-user interfaces.

You can find the template UIs in your Ory project under `Ory Managed UI` or  `$yourProjectSlug/hosted` .

You also have the option to implement your own user interface, for individual styling and branding.

This interface needs to be implemented in your application (e.g.
NodeJS + ExpressJS, Java, PHP, ReactJS, ...), and also rendered there. 
This enables you to customize your end-user experience and keep existing flows and designs. 

The JSON response from the Login Flow will be used to render the registration Login User Interface.
How this looks exactly depends on your business logic, framework and of course the programming language.

Ory Managed UI - Login User Interface:
<img alt="Ory Managed UI Login User Interface" src={('./code/login/images/browser.png')}/>

## Login Form Validation

The form payloads are then submitted to Ory which responds with:

- For Browser Clients: An `HTTP 302 Found` redirect to the Login UI for browser
  clients.
- For API Clients: An `application/json` response for API Clients.

### Login with Username/Email and Password

To finish the Login Flow, the end-user fills out the Login Form.

The Login Form must include a field marked as the identifier in the Identity JSON
Schema, for example:

<CodeTabs items={getFlowMethodPasswordWithErrors} />

If the Login payload is invalid (e.g. the password or identifier is invalid, a field is missing ...), the password method includes the
validation errors.

When validation errors happen, Browser Clients receive a HTTP 302 Found redirect
to the Login Flow UI, containing the Login Flow ID which includes
the error payloads.

For API Clients, the server typically responds with HTTP 400 Bad Request and the
Login Flow in the response payload as JSON.

## Successful Login

A successful Login is different for Browser Clients and API Clients. 

### Browser Clients

When the login is completed successfully, Ory Kratos responds with a HTTP 302
Redirect to the configured redirect URL.

You can configure this in the Ory Projects Settings.

A `Set-Cookie` HTTP Header is set
alongside the HTTP 302 redirect which contains the Ory Login Session.

```
HTTP/1.1 302 Found
Cache-Control: 0
Location: https://$ORY_PROJECT_SLUG/api/kratos/public
Set-Cookie: csrf_token=b8OebRPTPr5ow23mA5gIZmFNLeuMbv8pZz1jT1Ex7ys=; Path=/; Domain=127.0.0.1; Max-Age=31536000; HttpOnly
Set-Cookie: ory_kratos_session=MTU5OTE2ODc2N3xEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJR055VlROMGRteHhSakJrUzBkbmRUUjBlVFY1V0RCRWFVTnJXVmR6V25oaHx2DICsB6IMbaHSQwnYITUZqr7Qx7CxUlnaneJWH495wQ==; Path=/; Expires=Fri, 04 Sep 2020 21:32:47 GMT; Max-Age=86400; HttpOnly; SameSite=Lax
Vary: Cookie
Date: Thu, 03 Sep 2020 21:32:47 GMT
Content-Length: 0
```

Now, whenever the browser is making a request (with cookies) to the
`$ORY_PROJECT_SLUG/api/kratos/public/sessions/whoami` endpoint, the session will be returned:

```shell script
curl -s -H "Cookie: ory_kratos_session=MTYyMzEwMDYxNHxEdi1CQkFFQ180SUFBUkFCRUFBQVJfLUNBQUVHYzNSeWFXNW5EQThBRFhObGMzTnBiMjVmZEc5clpXNEdjM1J5YVc1bkRDSUFJRkZKVUhCbVJEY3pWbWhETVRsUWVGZzJVV1UwVVhCV1kyUTFWVmRRZDNWMXxteOfMb2i6K04dgF8CBUJXREBqJWeelqflyya7PrF2xQ==" \
  https://https://$ORY_PROJECT_SLUG/api/kratos/public/sessions/whoami | jq

{
  "id": "21c0b8fd-2835-4c73-9f5e-d4381525e6bc",
  "active": true,
  "expires_at": "2021-06-08T21:16:54.808916Z",
  "authenticated_at": "2021-06-07T21:16:54.808916Z",
  "issued_at": "2021-06-07T21:16:54.808943Z",
  "identity": {
    "id": "51b01e6d-6be5-4cbb-9b9b-527d21671422",
    "schema_id": "default",
    "schema_url": "https://https://$ORY_PROJECT_SLUG/api/kratos/public/schemas/default",
    "traits": {
      "email": "foo@ory.sh",
      "name": {
        "first": "Foo",
        "last": "Bar"
      },
      "newsletter": false
    },
    "verifiable_addresses": [
      {
        "id": "e84838e9-5b48-4410-add8-e9b59735239f",
        "value": "foo@ory.sh",
        "verified": false,
        "via": "email",
        "status": "sent",
        "verified_at": null,
        "created_at": "2021-06-07T21:16:44.944961Z",
        "updated_at": "2021-06-07T21:16:44.944961Z"
      }
    ],
    "recovery_addresses": [
      {
        "id": "3100768e-601c-4f60-bdb5-ad7dddbcc350",
        "value": "foo@ory.sh",
        "via": "email",
        "created_at": "2021-06-07T21:16:44.951037Z",
        "updated_at": "2021-06-07T21:16:44.951037Z"
      }
    ],
    "created_at": "2021-06-07T21:16:44.939873Z",
    "updated_at": "2021-06-07T21:16:44.939873Z"
  }
}
```

### API Clients

For API Clients, Ory responds with a JSON payload which includes the
identity which just authenticated, the session, and the Ory Kratos Session
Token.

The Ory Kratos Session Token can be checked at the
`https://$ORY_PROJECT_SLUG/api/kratos/public/sessions/whoami` endpoint:

## Refreshing a Session

Sometimes you need to refresh a Login Session, for example when updating the password. 
Refreshing a session updates the `authenticated_at` time.

:::info

Refreshing a session will not log the user out, unless another user signs in.

:::

To refresh a session, append `?refresh=true` to:

- `/self-service/login/browser` for browser Clients (e.g.
  `https://$ORY_PROJECT_SLUG/api/kratos/public/self-service/login/browser?refresh=true`)
- `/self-service/login/api` for API Clients (e.g.
  `https://$ORY_PROJECT_SLUG/api/kratos/public/self-service/login/api?refresh=true`)


---
id: custom-ui-advanced-integration
title: Advanced Integration
sidebar_label: Advanced Integration
toc_max_heading_level: 4
---

```mdx-code-block
import Tabs from "@theme/Tabs"
import TabItem from "@theme/TabItem"
import CodeBlock from "@theme/CodeBlock"
```

This document goes into detail on advanced topics such as Social Sign In, Passwordless, Two-Factor authentication. It is
recommended to read the [Integration Basics](./custom-ui-basic-integration) first.

## Advanced redirects

Most of the time, the application integrating with Ory would have advanced URL redirects. For example, the application might have
a protected page that the user is redirected from to the login page. After the user has logged in, the user should be redirected
back to the page they were on.

To achieve this, the application can pass a `?return_to=<url>` query parameter to the initialize flow endpoint
[`/self-service/<login|registration|settings|verification|recovery|logout>/browser?return_to=https://myapp.com/protected`](../reference/api#tag/frontend).

The `return_to` URL will be used as the redirect URL after the flow has been completed. For example, in the case of a `login` flow
we would redirect after a successful login has been completed.

Here is a breakdown of how the redirect works:

1. Initialize the flow with a `return_to` URL
2. Use the flow data to render the UI.
3. Submit the flow with user data. (e.g. username and password)
4. Assuming the flow was successful, the user will be redirected to the `return_to` URL.

The `return_to` query parameter does not automatically persist across different flows, the `return_to` will need to be re-added on
a new flow. For example, if the user has started a `login` flow with the `return_to` URL set and then switches to a `registration`
flow, the `return_to` URL will not be used for the registration flow.

The only case where the `return_to` URL will persist across flows are with a `recovery` flow transitioning into a `settings` flow.

Let's take a look at an example of how this works:

1. Create a `recovery` flow with `return_to`
2. Email is sent with a `link` or `code` method
3. User completes the `recovery` flow by submitting the `code` or clicking the `link`.
4. The user is given a session and redirected through the `settings` flow.
5. The user submits the `settings` flow with an updated password.
6. The user is redirected to the `return_to` URL.

## Login

We can submit the login flow with user data (e.g. username and password) using the flow ID. Depending on the type of application
(e.g. browser or native) the CSRF tokens are required in the request body and cookie.

In some cases, such as submitting WebAuthn passwordless, the response code could be `422` which indicates that the browser needs
to be redirected with a newly created flow. In Single Page Applications (SPAs) instead of redirecting, the response can be decoded
and the new flow ID extracted.

### Verification required

A session cookie or token can also be prevented on login using additional checks, such as only allowing verified users to login.
For more information, please take a look at
[Customize login and registration](../identities/sign-in/actions#allow-login-only-with-verified-email)

### Refreshing a user session

It is sometimes required to refresh an active user session beyond the global default session lifespan. In such a case the
application implementing the UI can request through the `?refresh=true` query parameter that Ory should refresh the already
existing session [`/self-service/login/browser?refresh=true`](../reference/api#tag/frontend/operation/createBrowserLoginFlow).
This is only applicable to the `login` flow and requires the user to already be logged in.

A common use case would be:

1. User logs in
2. User interacts with the application
3. User is inactive for a period of time
4. The user returns before the global default session lifespan has expired
5. The session is refreshed through a `login` flow with the `?refresh=true` query parameter.

### Two-Factor authentication

Two-Factor authentication (2FA) is a second step to confirming the user's credentials with another credential, such as `TOTP` or
`WebAuthn`. When creating a login flow, you can specify the `?aal=<level>` query parameter to specify the level of authentication.

In Ory the levels are:

- aal1: Password or OIDC
- aal2: aal1 + TOTP or WebAuthn or Lookup Secrets

In the case of initializing a second factor, the user must already have a valid session cookie. The
[`/sessions/whoami`](../reference/api#tag/frontend/operation/toSession) endpoint will return with an error with an id
`session_aal2_required` if the user is required to complete a second factor. More information on UI error messages can be found on
the [Customize user interface](../kratos/concepts/ui-user-interface) page.

For more information on Multi-factor authentication, take a look at the [Multi-factor authentication](../kratos/mfa/overview).

### Passwordless authentication

Passwordless authentication uses WebAuthn to authenticate a user using a hardware key or biometrics (such as touchID).

To enable passwordless authentication, take a look at the [WebAuthn and FIDO2](../kratos/mfa/webauthn-fido-yubikey) document.

:::info

Passwordless authentication cannot be enabled together with WebAuthn Two-Factor authentication. Ensure that you have disabled the
WebAuthn Two-Factor authentication before enabling passwordless authentication.

:::

In your application, you will need to add the WebAuthn JavaScript to the page.

````mdx-code-block
<Tabs groupId="webauthn">

<TabItem value="ts" label="React" default>

```mdx-code-block
import webAuthnMapping from '!!raw-loader!../../code-examples/sdk/typescript/src/ui/webauthn-mapping.tsx'

<CodeBlock language="tsx">{webAuthnMapping}</CodeBlock>
```

</TabItem>

</Tabs>
````

## Registration

### Getting a session after registration

:::note

A session cookie or token is only available after registration when enabled in the Ory configuration. More information can be
found in [Customize login and registration](../identities/sign-in/actions#log-in-users-after-registration).

:::

### Custom Identity Traits

The registration flow can map custom identity traits to the user based on the Identity Schema.

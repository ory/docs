---
id: dotnet
title: Integrate authentication into ASP.NET Core
sidebar_label: Dotnet / ASP.NET Core
---

```mdx-code-block
import CodeBlock from '@theme/CodeBlock'
import Teaser from '../_common/teaser.mdx'
import mp4 from '../_static/go/screencast.mp4'
import webm from '../_static/go/screencast.webm'

<Teaser
  language={<a href="https://dotnet.microsoft.com/en-us/">.NET</a>}
  framework={<a href="https://dotnet.microsoft.com/en-us/apps/aspnet">ASP.NET Core</a>}
  mp4={mp4}
  webm={webm}
  url="https://github.com/ory/docs/tree/master/code-examples/protect-page-login/dotnet/01-basic"
/>
```

## Install Ory CLI

Follow [this guide](../../guides/cli/01_installation.mdx) to install the Ory CLI on your machine.

### Why do I Need the Ory CLI?

```mdx-code-block
import OryCLI from '../_common/ory-cli.mdx'

<OryCLI />
```

### Usage of Ory Tunnel

We will be using the [Ory Tunnel](../../guides/cli/proxy-and-tunnel#ory-tunnel) in this tutorial. The interactions being performed
in his example are shown here:
[![Interactions for authenticating users in this example](https://mermaid.ink/img/pako:eNq9U7FOxDAM_RUrCwNUvQGWDEitQOgG4CS6IHUJqXuNaJPiOCCE-HeS9uA47iSY6BDV9vOL_Ry_Ce0aFFJ4fApoNV4YtSY11BbipwI7G4YHpNkeFbHRZlSWoQTloST34g9FixS9d4GgGEdQvI-oEuKWXqEK1mJ_gGK13ECOfDJ8bWdQmZ2fHxcSri4r6JhHmee906rvnGd5tlgsZliRYJUE3aF-BI_eG7dhqCaG1fJgMPpjOIuZrTI9NtuUrNj1pRuyUgJhYwg1A7v9gk5jQbnHvs2iUM9GY4ytjc0fvktXbmo92NKfGLYtJY5f4TeOEcisOwbXwpQ3IrWOhtjN2ngmxVERULbJHcHEMJ36p0g-aB3la0M_o77J9Zs021n920g31e7OdMf5OdQkHoJ2ltHG5ytOxIA0KNPEZXlL0FpwhwPWQsbfRtFjLWr7HnFpa-5erRaSKeCJCGOj-HOxhGxV77-8l41hR19OnMzreSWnzXz_ADSbKoU?type=png)](https://mermaid-js.github.io/mermaid-live-editor/edit#pako:eNq9U7FOxDAM_RUrCwNUvQGWDEitQOgG4CS6IHUJqXuNaJPiOCCE-HeS9uA47iSY6BDV9vOL_Ry_Ce0aFFJ4fApoNV4YtSY11BbipwI7G4YHpNkeFbHRZlSWoQTloST34g9FixS9d4GgGEdQvI-oEuKWXqEK1mJ_gGK13ECOfDJ8bWdQmZ2fHxcSri4r6JhHmee906rvnGd5tlgsZliRYJUE3aF-BI_eG7dhqCaG1fJgMPpjOIuZrTI9NtuUrNj1pRuyUgJhYwg1A7v9gk5jQbnHvs2iUM9GY4ytjc0fvktXbmo92NKfGLYtJY5f4TeOEcisOwbXwpQ3IrWOhtjN2ngmxVERULbJHcHEMJ36p0g-aB3la0M_o77J9Zs021n920g31e7OdMf5OdQkHoJ2ltHG5ytOxIA0KNPEZXlL0FpwhwPWQsbfRtFjLWr7HnFpa-5erRaSKeCJCGOj-HOxhGxV77-8l41hR19OnMzreSWnzXz_ADSbKoU)

## Setup

### Create an ASP.NET Core app

We will base this on the empty web template. Run these commands:

```shell-session
mkdir your-project
cd your-project

dotnet new web
```

![Create ASP.NET Core app](../_static/dotnet/new_project.gif)

### Install Ory SDK

Run this command to install the Ory SDK which allows you to interact with Ory APIs:

```shell-session
dotnet add package Ory.Client
```

![Add Ory.Client package](../_static/dotnet/add_package.gif)

### Configure the SDK

We will need to add the Ory Client to this app. Make the following changes to the `Program.cs` file that was generated:

```csharp title="Program.cs" showLineNumbers
// add-lines-start
using Ory.Client.Api;
using Ory.Client.Client;
// add-lines-end

var builder = WebApplication.CreateBuilder(args);

// add-lines-start
// configure http port explicitly to override generated settings from launchSettings.json
builder.WebHost.ConfigureKestrel(opt => {
	var port = builder.Configuration.GetValue<int>("APP_PORT", 5001);
	opt.ListenAnyIP(port);
});
// add-lines-end

var app = builder.Build();

// add-lines-start
// create a new Ory Client with the BasePath set to the Ory Tunnel enpoint
var oryBasePath = builder.Configuration.GetValue<string>("ORY_BASEPATH") ?? "http://localhost:4000";
var ory = new FrontendApi(new Configuration
{
	BasePath = oryBasePath
});
// add-lines-end

app.MapGet("/", () => "Hello World!");

app.Run();
```

## Validate and login

Next, create middleware that checks if the user has a valid session. The session is considered valid when the user is
authenticated.

The middleware passes the request cookies to the Ory client to check if the session is valid.

If the session is valid, the user is presented with the protected page. When the session is not valid, which means that the user
is not authenticated or the session expired, the request is redirected for login using the Ory Account Experience.

```csharp title="Program.cs" showLineNumbers
using Ory.Client.Api;
using Ory.Client.Client;

var builder = WebApplication.CreateBuilder(args);

// configure http port explicitly to override generated settings from launchSettings.json
builder.WebHost.ConfigureKestrel(opt => {
	var port = builder.Configuration.GetValue<int>("APP_PORT", 5001);
	opt.ListenAnyIP(port);
});

var app = builder.Build();

// create a new Ory Client with the BasePath set to the Ory Tunnel enpoint
var oryBasePath = builder.Configuration.GetValue<string>("ORY_BASEPATH") ?? "http://localhost:4000";
var ory = new FrontendApi(new Configuration
{
	BasePath = oryBasePath
});

// add-lines-start
// add session middleware
app.Use(async (ctx, next) =>
{
	async Task Login()
	{
		// this will redirect the user to the managed Ory Login UI
		var flow = await ory.CreateBrowserLoginFlowAsync() ?? throw new InvalidOperationException("Could not create browser login flow");
		ctx.Response.Redirect(flow.RequestUrl);
	}

	try
	{
		// check if we have a session
		var session = await ory.ToSessionAsync(cookie: ctx.Request.Headers.Cookie, cancellationToken: ctx.RequestAborted);
		if (session?.Active is not true)
		{
			await Login();
			return;
		}

		// add session to HttpContext
		ctx.Items["req.session"] = session;
	}
	catch (ApiException)
	{
		await Login();
		return;
	}

	await next(ctx);
});
// add-lines-end

app.MapGet("/", () => "Hello World!");

app.Run();
```

## The protected page

As the final step, create an `Index` page that's presented to signed-in users. This page diplays the user's session data.

### Create the page

Create the `Index` RazorPage that renders the page with the session data:

```shell-session
dotnet new page --name Index --no-pagemodel --output Pages
```

Add this code to the `Pages/Index.cshtml` file to present the data to the user:

```cshtml title="Pages/Index.cshtml" showLineNumbers
@page
@{
  // add-lines-start
  // try to retrieve session from HttpContext
  var session = HttpContext.Items.TryGetValue("req.session", out var item) && item is Ory.Client.Model.ClientSession s ? s.ToJson() : "<NO SESSION>";
  // add-lines-end
}

// add-lines-start
<html lang="en">
  <head>
    <title>Ory Network secured ASP.NET Core web app</title>
  </head>
  <body>
    <h1>Dashboard</h1>
    <hr />
    <h2>Your Session Data:</h2>
    <pre><code>@session</code></pre>
  </body>
</html>
// add-lines-end
```

### App configuration

To configure the app to serve RazorPages, make the following changes in `Program.cs`. Make sure, you replace the line
`app.MapGet("/", () => "Hello World!");` with `app.MapRazorPages();`.

```csharp title="Program.cs" showLineNumbers
using Ory.Client.Api;
using Ory.Client.Client;

var builder = WebApplication.CreateBuilder(args);

// configure http port explicitly to override generated settings from launchSettings.json
builder.WebHost.ConfigureKestrel(opt => {
	var port = builder.Configuration.GetValue<int>("APP_PORT", 5001);
	opt.ListenAnyIP(port);
});

// add-lines-start
// add support for RazorPages
builder.Services.AddRazorPages();
// add-lines-end

var app = builder.Build();

// create a new Ory Client with the BasePath set to the Ory Tunnel enpoint
var oryBasePath = builder.Configuration.GetValue<string>("ORY_BASEPATH") ?? "http://localhost:4000";
var ory = new FrontendApi(new Configuration
{
	BasePath = oryBasePath
});

// add session middleware
app.Use(async (ctx, next) =>
{
	async Task Login()
	{
		// this will redirect the user to the managed Ory Login UI
		var flow = await ory.CreateBrowserLoginFlowAsync() ?? throw new InvalidOperationException("Could not create browser login flow");
		ctx.Response.Redirect(flow.RequestUrl);
	}

	try
	{
		// check if we have a session
		var session = await ory.ToSessionAsync(cookie: ctx.Request.Headers.Cookie, cancellationToken: ctx.RequestAborted);
		if (session?.Active is not true)
		{
			await Login();
			return;
		}

		// add session to HttpContext
		ctx.Items["req.session"] = session;
	}
	catch (ApiException)
	{
		await Login();
		return;
	}

	await next(ctx);
});

// add-lines-start
// configure pipeline to use RazorPages
app.MapRazorPages();
// add-lines-end
// delete-next-line
app.MapGet("/", () => "Hello World!");

app.Run();
```

## Test your application

With all of the pieces in place, it's time to test your application. Follow these steps:

1. Start your ASP.NET app:

```shell-session
dotnet run
```

![Run ASP.NET Core app](../_static/dotnet/dotnet_run.gif)

2. Run the Ory Tunnel to mirror the Ory API endpoints on your application's domain (`localhost`):

```shell-session
ory tunnel --project playground --dev http://localhost:5001
```

![Run Ory Tunnel](../_static/dotnet/ory_tunnel.gif)

3. Open [localhost:5001](http://localhost:5001) to access the application. As the initial call is made by an unauthenticated user,
   the middleware doesn't detect a valid session and redirects to the login page of the defined Ory project.
   <br />
   <br />
   From there, you can create a new account or sign in using an existing identity. When you sign in, the session becomes valid and
   the application shows the `Index` page with the session data.

## More advanced scenarios

For a more advanced example of integrating Ory with ASP.NET Core please have a look at the
[examples repository](https://github.com/ory/examples/tree/master/dotnet-ory-network).

## Go to production

```mdx-code-block
import ToProd from '../_common/going-to-prod.mdx'

<ToProd />
```

```csharp
// register a new Ory client with the URL set to the custom domain
var ory = new FrontendApi(new Configuration
{
	BasePath = "https://ory.example.org"
});
```
